<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Generated Quiz</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="topbar">
        <div class="brand">
          <div class="logo">QG</div>
          <p>RefOo Quiz Generator</p>
        </div>
        <a href="/" class="btn ghost" style="margin-left:auto;flex-shrink:0;padding:8px 16px;font-size:14px;text-decoration:none;display:inline-flex;align-items:center;gap:6px">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          <span>Return</span>
        </a>
      </div>
      <div id="deck-id" style="display:none">{{ deck_id }}</div>

      <div class="card" style="margin-bottom:12px;padding:12px;background:rgba(111,76,255,0.05);border:1px solid rgba(111,76,255,0.1)">
        <div style="font-size:12px;color:var(--muted);margin-bottom:8px">Quiz ID (Share this to let others access this quiz):</div>
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
          <div id="quiz-id-display" style="font-family:monospace;font-size:16px;font-weight:600;color:var(--accent);word-break:break-all;flex:1;min-width:200px">{{ deck_id }}</div>
          <button id="copy-quiz-id-btn" class="btn ghost" style="flex-shrink:0;padding:8px 16px;font-size:14px">Copy ID</button>
        </div>
      </div>

      <div id="loading-indicator" class="loading-overlay">
        <div class="loading-content">
          <div class="spinner"></div>
          <div style="margin-top:16px;color:var(--muted);font-size:14px">Generating questions...</div>
        </div>
      </div>

      <div class="card">
        <div class="meta" id="progress">Question 0 of 0</div>
        <div id="cards" class="quiz-grid">
          <!-- Single-card exam UI will be rendered client-side. If any initial cards were passed, they will be shown by JS. -->
        </div>
      </div>

      <div class="fixed-controls">
        <div class="control-row" style="display:flex;gap:12px;align-items:center">
          <div class="left-controls" style="flex:1;display:flex;gap:8px;align-items:center">
            <button id="prev" class="btn ghost prev-button" style="width:100%">Previous</button>
          </div>
          <div class="right-controls" style="flex:4">
            <button id="next" class="btn next-button" style="width:100%">Next</button>
          </div>
        </div>
      </div>

    </div>

    <script>
      (function(){
        const deckId = document.getElementById('deck-id').textContent.trim();
        const cardsContainer = document.getElementById('cards');
        

        // exam state
        let cards = [];
        let idx = 0;

        const prevBtn = document.getElementById('prev');
        const nextBtn = document.getElementById('next');
        const progress = document.getElementById('progress');

        function renderCardAt(i){
          const slot = document.getElementById('card-slot');
          if(!slot) return;
          slot.innerHTML = '';
          if(cards.length===0){
            slot.innerHTML = '<div class="card-quiz"><div class="q">No cards yet — waiting for generation</div></div>';
            progress.textContent = 'Question 0 of 0';
            prevBtn.disabled = true; nextBtn.disabled = true;
            return;
          }
          const c = cards[i];
          progress.textContent = 'Question ' + (i+1) + ' of ' + cards.length;

          const wrapper = document.createElement('div'); wrapper.className='card-quiz'; wrapper.setAttribute('data-card-id', c.card_id);
          if(c.card_type){ const b = document.createElement('div'); b.className='badge'; b.textContent=c.card_type; wrapper.appendChild(b); }
          if(c.case_details){ const cs = document.createElement('div'); cs.className='case'; cs.innerHTML = '<em>Case:</em> ' + c.case_details; wrapper.appendChild(cs); }
          const q = document.createElement('div'); q.className='q'; q.textContent = c.question; wrapper.appendChild(q);

          if(c.options && c.options.length){
            const opts = document.createElement('div'); opts.className='options';
            c.options.forEach((opt,ii) => {
                const lab = document.createElement('label'); lab.className='option';
                const inp = document.createElement('input'); inp.type='radio'; inp.name='answer'; inp.value = opt; inp.id = 'opt'+ii;
                lab.appendChild(inp);

                const inner = document.createElement('div'); inner.className='option-inner';
                const txtdiv = document.createElement('div'); txtdiv.className='option-text'; txtdiv.textContent = opt;
                inner.appendChild(txtdiv);
                
                // Add icon containers for checkmark/X (both, but only show when needed)
                const checkIcon = document.createElement('div');
                checkIcon.className = 'option-icon check-icon';
                checkIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                
                const xIcon = document.createElement('div');
                xIcon.className = 'option-icon x-icon';
                xIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
                
                inner.appendChild(checkIcon);
                inner.appendChild(xIcon);
                
                lab.appendChild(inner);

                // Add click animation
                lab.addEventListener('click', function(e){
                  if(lab.dataset.locked) return;
                  inner.classList.add('animating');
                  setTimeout(() => {
                    inner.classList.remove('animating');
                  }, 400);
                });

                // immediate validation when user selects an option
                inp.addEventListener('change', function(e){
                  // prevent double-handling
                  if(lab.dataset.locked) return;
                  lab.dataset.locked = '1';

                  const ansDivLocal = wrapper.querySelector('.answer');
                  // Understanding/explanation type — show blurred content, allow reveal
                  if(c.card_type && String(c.card_type).toLowerCase().includes('understand')){
                    ansDivLocal.style.display = 'block';
                    ansDivLocal.classList.add('blurred');
                    // reveal on click
                    function reveal(){ ansDivLocal.classList.remove('blurred'); ansDivLocal.classList.add('revealed'); ansDivLocal.removeEventListener('click', reveal); }
                    ansDivLocal.addEventListener('click', reveal);
                    // lock inputs
                    wrapper.querySelectorAll('input[name=answer]').forEach(i=>i.disabled=true);
                    return;
                  }

                  // MCQ / standard validation
                  const selectedValue = e.target.value;
                  const isCorrect = selectedValue === (c.answer || '');

                  // clear any previous highlights and icons
                  wrapper.querySelectorAll('.option-inner').forEach(el=>{
                    el.classList.remove('correct','incorrect');
                    el.querySelectorAll('.option-icon').forEach(icon=>{
                      icon.style.opacity = '0';
                      icon.style.transform = 'translateY(-50%) scale(0)';
                      icon.style.display = 'flex';
                    });
                  });

                  // Add slight delay for better animation effect
                  setTimeout(() => {
                    if(isCorrect){
                      const chosenInner = e.target.closest('.option').querySelector('.option-inner');
                      if(chosenInner){
                        chosenInner.classList.add('correct');
                        const checkIcon = chosenInner.querySelector('.check-icon');
                        const xIcon = chosenInner.querySelector('.x-icon');
                        if(checkIcon){
                          checkIcon.style.opacity = '1';
                          checkIcon.style.transform = 'translateY(-50%) scale(1)';
                          checkIcon.style.display = 'flex';
                        }
                        if(xIcon){
                          xIcon.style.display = 'none';
                        }
                      }
                    } else {
                      const chosenInner = e.target.closest('.option').querySelector('.option-inner');
                      if(chosenInner){
                        chosenInner.classList.add('incorrect');
                        const checkIcon = chosenInner.querySelector('.check-icon');
                        const xIcon = chosenInner.querySelector('.x-icon');
                        if(xIcon){
                          xIcon.style.opacity = '1';
                          xIcon.style.transform = 'translateY(-50%) scale(1)';
                          xIcon.style.display = 'flex';
                        }
                        if(checkIcon){
                          checkIcon.style.display = 'none';
                        }
                      }
                      // highlight correct one with delay
                      setTimeout(() => {
                        const correctInput = Array.from(wrapper.querySelectorAll('input[name=answer]')).find(i=>i.value === (c.answer || ''));
                        if(correctInput){
                          const corrInner = correctInput.closest('.option').querySelector('.option-inner');
                          if(corrInner){
                            corrInner.classList.add('correct');
                            const checkIcon = corrInner.querySelector('.check-icon');
                            const xIcon = corrInner.querySelector('.x-icon');
                            if(checkIcon){
                              checkIcon.style.opacity = '1';
                              checkIcon.style.transform = 'translateY(-50%) scale(1)';
                              checkIcon.style.display = 'flex';
                            }
                            if(xIcon){
                              xIcon.style.display = 'none';
                            }
                          }
                        }
                      }, 200);
                    }
                  }, 50);

                  // show answer text if an answer block exists (only for understanding cards)
                  if(ansDivLocal){
                    ansDivLocal.style.display = 'block';
                    ansDivLocal.textContent = (isCorrect ? 'Correct — ' : 'Incorrect — ') + 'Answer: ' + (c.answer || '');
                  }

                  // lock inputs
                  wrapper.querySelectorAll('input[name=answer]').forEach(i=>i.disabled=true);
                });

                opts.appendChild(lab);
            });
            wrapper.appendChild(opts);
          }

          // For understanding/explanation cards render a blurred explanation block that can be revealed.
          if(c.card_type && String(c.card_type).toLowerCase().includes('understand')){
            const ansDiv = document.createElement('div'); ansDiv.className='answer';
            ansDiv.textContent = c.explanation || c.answer || '';
            ansDiv.style.display = 'block';
            ansDiv.classList.add('blurred');
            function revealInit(){ ansDiv.classList.remove('blurred'); ansDiv.classList.add('revealed'); ansDiv.removeEventListener('click', revealInit); }
            ansDiv.addEventListener('click', revealInit);
            wrapper.appendChild(ansDiv);
          }
          cardsContainer.innerHTML = ''; // show only the slot
          const slotWrap = document.createElement('div'); slotWrap.id = 'card-slot'; slotWrap.appendChild(wrapper);
          cardsContainer.appendChild(slotWrap);

          // update navigation buttons
          prevBtn.disabled = (i===0);
          nextBtn.disabled = (i >= cards.length-1);
        }

        prevBtn.addEventListener('click', ()=>{ if(idx>0){ idx--; renderCardAt(idx); }});
        nextBtn.addEventListener('click', ()=>{ if(idx < cards.length-1){ idx++; renderCardAt(idx); }});

        // Selection is handled immediately on input change (see input listeners created when rendering options).

        // initial empty slot
        const slotInit = document.createElement('div'); slotInit.id='card-slot'; cardsContainer.appendChild(slotInit);

        // loading indicator
        const loadingIndicator = document.getElementById('loading-indicator');
        let hasShownFirstCard = false;

        function hideLoadingIndicator(){
          if(loadingIndicator && !hasShownFirstCard){
            loadingIndicator.style.display = 'none';
            hasShownFirstCard = true;
          }
        }

        // connect EventSource
        const es = new EventSource(`/stream_cards/${encodeURIComponent(deckId)}`);
        es.onmessage = function(e){
          try{
            const payload = JSON.parse(e.data);
            if(!payload || !payload.cards) return;
            payload.cards.forEach(card => {
              if(!card.card_id) return;
              if(!cards.find(x=>x.card_id===card.card_id)){
                cards.push(card);
              }
            });
            // render first card when ready
            renderCardAt(idx);
            // hide loading indicator when first card appears
            if(cards.length > 0){
              hideLoadingIndicator();
            }
          }catch(err){ console.error('invalid message', err, e.data); }
        };

        es.addEventListener('done', function(){
          es.close();
        });

        es.onerror = function(err){ console.error('EventSource failed', err); };

        // Copy Quiz ID functionality
        const copyQuizIdBtn = document.getElementById('copy-quiz-id-btn');
        const quizIdDisplay = document.getElementById('quiz-id-display');
        
        copyQuizIdBtn.addEventListener('click', function(){
          const quizId = quizIdDisplay.textContent.trim();
          if(navigator.clipboard && navigator.clipboard.writeText){
            navigator.clipboard.writeText(quizId).then(function(){
              const originalText = copyQuizIdBtn.textContent;
              copyQuizIdBtn.textContent = 'Copied!';
              copyQuizIdBtn.style.background = 'var(--accent)';
              copyQuizIdBtn.style.color = 'white';
              setTimeout(function(){
                copyQuizIdBtn.textContent = originalText;
                copyQuizIdBtn.style.background = '';
                copyQuizIdBtn.style.color = '';
              }, 2000);
            }).catch(function(err){
              console.error('Failed to copy:', err);
              alert('Failed to copy. Quiz ID: ' + quizId);
            });
          } else {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = quizId;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();
            try {
              document.execCommand('copy');
              const originalText = copyQuizIdBtn.textContent;
              copyQuizIdBtn.textContent = 'Copied!';
              setTimeout(function(){
                copyQuizIdBtn.textContent = originalText;
              }, 2000);
            } catch(err) {
              alert('Failed to copy. Quiz ID: ' + quizId);
            }
            document.body.removeChild(textArea);
          }
        });
        
        // Initialize Telegram WebApp
        let tg = null;
        if(window.Telegram && window.Telegram.WebApp){
          tg = window.Telegram.WebApp;
          tg.ready();
          tg.expand();
        }
        
        // Get user info (ID and name) from Telegram WebApp
        function getTelegramUserInfo(){
          if(window.Telegram && window.Telegram.WebApp){
            const webApp = window.Telegram.WebApp;
            
            // Try initDataUnsafe first
            if(webApp.initDataUnsafe && webApp.initDataUnsafe.user){
              const user = webApp.initDataUnsafe.user;
              return {
                id: user.id ? String(user.id) : null,
                name: user.first_name || user.username || null,
                full_name: user.first_name && user.last_name 
                  ? `${user.first_name} ${user.last_name}`.trim()
                  : user.first_name || user.username || null
              };
            }
            
            // Try parsing initData string
            if(webApp.initData){
              try{
                const params = new URLSearchParams(webApp.initData);
                const userParam = params.get('user');
                if(userParam){
                  const user = JSON.parse(decodeURIComponent(userParam));
                  return {
                    id: user.id ? String(user.id) : null,
                    name: user.first_name || user.username || null,
                    full_name: user.first_name && user.last_name 
                      ? `${user.first_name} ${user.last_name}`.trim()
                      : user.first_name || user.username || null
                  };
                }
              } catch(e){
                console.log('Error parsing initData:', e);
              }
            }
          }
          return { id: null, name: null, full_name: null };
        }
        
        // Notify admin when mini app is opened
        (async function notifyAdminOnLoad(){
          const userInfo = getTelegramUserInfo();
          if(userInfo.id){
            try{
              await fetch('/api/notify-admin', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  user_id: userInfo.id,
                  user_name: userInfo.full_name || userInfo.name || 'Unknown',
                  page: 'quiz'
                })
              });
            } catch(e){
              console.error('Error notifying admin:', e);
            }
          }
        })();
        
      })();
    </script>
  </body>
</html>
