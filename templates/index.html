<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AI Quiz Generator</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/static/common.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="topbar">
        <div class="brand">
          <div class="logo">QG</div>
          <p>RefOo Quiz Generator</p>
        </div>
      </div>
      <div style="height:24px"></div>

      {% if error %}
        <div class="card" style="border-left:4px solid var(--danger);margin-bottom:12px">{{ error }}</div>
      {% endif %}

      <div class="card" style="margin-bottom:16px">
        <h3 style="margin:0 0 12px 0;font-size:18px;font-weight:600">Load Existing Quiz</h3>
        <form method="get" action="/" style="display:flex;gap:8px;align-items:flex-end">
          <div style="flex:1">
            <input type="text" name="quiz_id" id="quiz-id-input" class="input" placeholder="Enter Quiz ID,e.g., eK6fVwO4KTa7c..." style="margin-top:8px">
          </div>
          <button type="submit" class="btn" style="flex-shrink:0;padding:10px 20px">Load Quiz</button>
        </form>
      </div>

      <div class="card">
        <form method="post" action="/generate" enctype="multipart/form-data" id="quiz-form">
          <div class="form-grid">
            <div>
              <label class="small">Upload file (PDF or Word):</label>
              <div id="file-upload-area" class="file-upload-area">
                <input type="file" name="file" id="file-input" accept=".pdf,.doc,.docx" style="display:none">
                <div id="file-upload-content" class="file-upload-content">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--muted);margin-bottom:12px">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                  </svg>
                  <div style="margin-bottom:8px;font-weight:600;color:var(--black)">Click to upload or drag and drop</div>
                  <div style="font-size:13px;color:var(--muted);margin-bottom:12px">PDF, DOC, or DOCX (max 16MB)</div>
                  <label for="file-input" class="btn ghost" style="cursor:pointer">
                    Browse Files
                  </label>
                </div>
                <div id="file-selected-content" class="file-selected-content" style="display:none">
                  <div style="display:flex;align-items:center;gap:12px;flex:1">
                    <div style="width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;flex-shrink:0">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                      </svg>
                    </div>
                    <div style="flex:1;min-width:0">
                      <div id="file-name" style="font-weight:600;color:var(--black);margin-bottom:4px;word-break:break-word"></div>
                      <div id="file-size" style="font-size:13px;color:var(--muted)"></div>
                    </div>
                  </div>
                  <button type="button" id="remove-file-btn" class="btn ghost" style="flex-shrink:0;padding:8px 12px;font-size:14px">Remove</button>
                </div>
              </div>
              
              <div id="page-range-container" style="display:none;margin-top:12px;margin-bottom:12px;padding:12px;background:rgba(16,24,40,0.02);border-radius:6px;border:1px solid rgba(16,24,40,0.04)">
                <label class="small">Page Range (optional):</label>
                <div style="display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap">
                  <input type="number" name="page_start" id="page-start" min="1" placeholder="Start" class="input" style="width:100px">
                  <span style="color:var(--muted)">to</span>
                  <input type="number" name="page_end" id="page-end" min="1" placeholder="End" class="input" style="width:100px">
                  <span id="total-pages" style="color:var(--muted);font-size:13px"></span>
                </div>
                <div id="page-range-error" style="margin-top:8px;color:var(--danger);font-size:13px;display:none"></div>
              </div>

              <div style="margin-top:18px">
                <label class="small">Question types (select one or more)</label>
                <div class="question-types">
                  <div class="segmented" role="group" style="flex-wrap:wrap">
                    <label class="seg-item"><input type="checkbox" name="question_type" value="Multiple Choice Question" checked><span>MCQ</span></label>
                    <label class="seg-item"><input type="checkbox" name="question_type" value="Case Scenario Multiple Choice Question"><span>CASE</span></label>
                    <label class="seg-item"><input type="checkbox" name="question_type" value="Understanding Question"><span>OPEN</span></label>
                    <label class="seg-item"><input type="checkbox" name="question_type" value="True/False Question"><span>T/F</span></label>
                  </div>
                </div>
              </div>

              <div style="display:flex;gap:12px;margin-top:18px;align-items:center;flex-wrap:wrap">
                <div style="flex:1">
                  <label class="small">Amount of questions</label>
                      <div class="segmented" role="radiogroup">
                        <label class="seg-item"><input type="radio" name="amount" value="low" checked><span>Low</span></label>
                        <label class="seg-item"><input type="radio" name="amount" value="medium"><span>Medium</span></label>
                        <label class="seg-item"><input type="radio" name="amount" value="high"><span>High</span></label>
                      </div>
                </div>
                <div style="min-width:160px">
                  <label class="small">Difficulty</label>
                  <div class="segmented" role="radiogroup">
                    <label class="seg-item"><input type="radio" name="difficulty" value="Basic" checked><span>Basic</span></label>
                    <label class="seg-item"><input type="radio" name="difficulty" value="Advanced"><span>Advanced</span></label>
                  </div>
                </div>
              </div>

              <div style="margin-top:18px" class="actions">
                <button id="generate-btn" class="btn" type="submit" style="width:100%; font-size: 16px;">
                  <span id="generate-btn-text">Generate Quiz</span>
                  <span id="generate-btn-spinner" class="spinner" style="display:none;margin-left:8px"></span>
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <script>
      (function(){
        'use strict';
        
        // Initialize Telegram WebApp
        initTelegramWebApp();
        
        // Notify admin when mini app is opened
        notifyAdmin('index');
        
        // DOM elements
        const fileInput = document.getElementById('file-input');
        const fileUploadArea = document.getElementById('file-upload-area');
        const fileUploadContent = document.getElementById('file-upload-content');
        const fileSelectedContent = document.getElementById('file-selected-content');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        const removeFileBtn = document.getElementById('remove-file-btn');
        const pageRangeContainer = document.getElementById('page-range-container');
        const pageStart = document.getElementById('page-start');
        const pageEnd = document.getElementById('page-end');
        const totalPages = document.getElementById('total-pages');
        const pageRangeError = document.getElementById('page-range-error');
        const form = document.getElementById('quiz-form');
        const generateBtn = document.getElementById('generate-btn');
        const generateBtnText = document.getElementById('generate-btn-text');
        const generateBtnSpinner = document.getElementById('generate-btn-spinner');
        
        let maxPages = null;
        let isPDF = false;

        // Remove file handler
        removeFileBtn.addEventListener('click', function(e) {
          e.preventDefault();
          fileInput.value = '';
          fileUploadContent.style.display = 'flex';
          fileSelectedContent.style.display = 'none';
          pageRangeContainer.style.display = 'none';
          maxPages = null;
          pageStart.value = '';
          pageEnd.value = '';
          pageRangeError.style.display = 'none';
        });

        // Drag and drop handlers
        fileUploadArea.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.stopPropagation();
          fileUploadArea.classList.add('drag-over');
        });

        fileUploadArea.addEventListener('dragleave', function(e) {
          e.preventDefault();
          e.stopPropagation();
          fileUploadArea.classList.remove('drag-over');
        });

        fileUploadArea.addEventListener('drop', function(e) {
          e.preventDefault();
          e.stopPropagation();
          fileUploadArea.classList.remove('drag-over');
          
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect();
          }
        });

        function handleFileSelect() {
          const file = fileInput.files[0];
          if (!file) return;
          
          fileName.textContent = file.name;
          fileSize.textContent = formatFileSize(file.size);
          fileUploadContent.style.display = 'none';
          fileSelectedContent.style.display = 'flex';
          
          const fileNameLower = file.name.toLowerCase();
          isPDF = fileNameLower.endsWith('.pdf');
          const isWord = fileNameLower.endsWith('.doc') || fileNameLower.endsWith('.docx');
          
          if (isPDF || isWord) {
            pageRangeContainer.style.display = 'block';
            maxPages = null;
            
            if (isPDF) {
              // Try to get page count from PDF
              getPDFPageCount(file, function(pageCount) {
                if (pageCount) {
                  maxPages = pageCount;
                  totalPages.textContent = `(Max: ${pageCount} pages)`;
                  pageStart.setAttribute('max', pageCount);
                  pageEnd.setAttribute('max', pageCount);
                  validatePageRange();
                } else {
                  totalPages.textContent = '(Page count will be determined after upload)';
                }
              });
            } else {
              totalPages.textContent = '';
              pageStart.removeAttribute('max');
              pageEnd.removeAttribute('max');
            }
            
            pageStart.value = '';
            pageEnd.value = '';
            pageRangeError.style.display = 'none';
          } else {
            pageRangeContainer.style.display = 'none';
            maxPages = null;
          }
        }

        fileInput.addEventListener('change', handleFileSelect);
        
        // Make upload area clickable
        fileUploadArea.addEventListener('click', function(e) {
          if (e.target === fileUploadArea || e.target.closest('.file-upload-content')) {
            fileInput.click();
          }
        });

        // Get PDF page count client-side
        function getPDFPageCount(file, callback) {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            try {
              const typedArray = new Uint8Array(e.target.result);
              // Simple PDF page count extraction
              const pdfString = new TextDecoder('latin1').decode(typedArray);
              const pageMatches = pdfString.match(/\/Count\s+(\d+)/g);
              
              if (pageMatches) {
                const counts = pageMatches.map(m => {
                  const match = m.match(/\d+/);
                  return match ? parseInt(match[0], 10) : 0;
                });
                const maxCount = Math.max(...counts);
                callback(maxCount > 0 ? maxCount : null);
              } else {
                // Fallback: count /Type/Page occurrences
                const pageOccurrences = (pdfString.match(/\/Type\s*\/Page[^s]/g) || []).length;
                callback(pageOccurrences > 0 ? pageOccurrences : null);
              }
            } catch (err) {
              console.error('Error reading PDF:', err);
              callback(null);
            }
          };
          
          reader.onerror = function() {
            console.error('Error reading file');
            callback(null);
          };
          
          reader.readAsArrayBuffer(file);
        }

        // Validate page range
        function validatePageRange() {
          const start = pageStart.value ? parseInt(pageStart.value, 10) : null;
          const end = pageEnd.value ? parseInt(pageEnd.value, 10) : null;
          let error = '';

          if (start !== null && start < 1) {
            error = 'Start page must be at least 1';
          } else if (end !== null && end < 1) {
            error = 'End page must be at least 1';
          } else if (start !== null && end !== null && start > end) {
            error = 'Start page must be less than or equal to end page';
          } else if (maxPages !== null) {
            if (start !== null && start > maxPages) {
              error = `Start page cannot exceed ${maxPages} pages`;
            } else if (end !== null && end > maxPages) {
              error = `End page cannot exceed ${maxPages} pages`;
            }
          }

          if (error) {
            pageRangeError.textContent = error;
            pageRangeError.style.display = 'block';
            return false;
          } else {
            pageRangeError.style.display = 'none';
            return true;
          }
        }


        // Validate on input
        pageStart.addEventListener('input', validatePageRange);
        pageStart.addEventListener('blur', validatePageRange);
        pageEnd.addEventListener('input', validatePageRange);
        pageEnd.addEventListener('blur', validatePageRange);

        // Form submission validation and button state
        form.addEventListener('submit', function(e) {
          if (!fileInput.files || fileInput.files.length === 0) {
            e.preventDefault();
            alert('Please select a file to upload');
            return false;
          }
          
          // Validate at least one question type is selected
          const selectedQuestionTypes = form.querySelectorAll('input[name="question_type"]:checked');
          if (selectedQuestionTypes.length === 0) {
            e.preventDefault();
            alert('Please select at least one question type');
            return false;
          }
          
          // Validate page range if visible
          if (pageRangeContainer.style.display !== 'none') {
            if (!validatePageRange()) {
              e.preventDefault();
              return false;
            }
          }
          
          // Disable button and show loading state
          generateBtn.disabled = true;
          generateBtn.style.opacity = '0.7';
          generateBtn.style.cursor = 'not-allowed';
          generateBtnText.textContent = 'Generating...';
          generateBtnSpinner.style.display = 'inline-block';
        });
      })();
    </script>
  </body>
</html>
